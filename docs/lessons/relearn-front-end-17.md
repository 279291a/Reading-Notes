# JavaScript 执行-宏观任务和微观任务

[toc]

## JavaScript 引擎

一个 JavaScript 引擎常驻内存，等待宿主把 JavaScript 代码或函数传递给它执行。

## 宏观任务和微观任务

**宏观任务**： 宿主发起的任务。

**微观任务**：JavaScript 引擎发起的任务。例如 ES5 之后引入的 Promise 。

**事件循环**：JavaScript 引擎等待宿主环境分配宏观任务，等待的行为就是一个事件循环。也可以这样理解，宏观任务的队列就相当于事件循环。

**微观任务队列**：在宏观任务中，JavaScript 的 Promise 会产生异步代码，这些异步代码会在一个宏观任务中完成，因此，每个宏观任务中又包含了一个微观任务队列。

### setTimeout 和 Promise

Promise 永远在队列尾部添加微观任务，setTimeout 作为宿主 api 则添加宏观任务。在执行顺序上，遵循**微观任务优先**原则。

## Promise

Promise 是 JavaScript 语言提供的一种标准化的异步管理方式，需要进行 io，等待或者其他异步操作的函数，不返回真实结果，而返回一个“承诺”。在合适的时机，通过 Promise 的 then 方法回调实现这个承诺。

### 基本用法

使用函数，返回一个 `new Promise()`，调用方直接调用该函数，如果想取到真实值，使用 `then()`

### 分析异步执行顺序的方法

1. 分析有多少个宏观任务
2. 分析有多少个微任务
3. 根据调用次序，确定宏观任务中微任务执行次序
4. 根据宏任务的触发规则和调用次序，确定宏任务的执行次序
5. 确定整个顺序

## async/await

### 作用

提供了用 for 、if 等代码结构来编写异步的方式。

### 基本用法

在 function 关键字之前加上 async 关键字，就成为 async 函数，该函数必定返回一个 Promise。在函数中使用 await 来等待一个 Promise。async 函数可以嵌套使用。
